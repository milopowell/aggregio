<!-- templates/aggregate_form.html -->
{% extends "base.html" %}

{% block title %}
{% if mode == 'edit' %}Edit Aggregate - Aggregio{% else %}New Aggregate - Aggregio{% endif %}
{% endblock %}

{% block content %}
<div class="form-container">
    <div class="header">
        <h1>
            {% if mode == 'edit' %}Edit Aggregate{% else %}Create New Aggregate{% endif %}
        </h1>
        <a href="/aggregates" class="btn btn-back">‚Üê Back to Aggregates</a>
    </div>
    
    <form method="POST" action="/aggregates/save" class="aggregate-form">
        {% if mode == 'edit' %}
            <input type="hidden" name="aggregate_id" value="{{ aggregate.id }}">
        {% endif %}
        
        <div class="form-section">
            <div class="form-group">
                <label for="name">Aggregate Name</label>
                <input type="text" 
                       id="name" 
                       name="name" 
                       value="{% if aggregate %}{{ aggregate.name }}{% endif %}" 
                       placeholder="Enter a name for your aggregate (e.g., 'Summer Training Block')"
                       required>
            </div>
        </div>
        
        <div class="form-section">
            <div class="section-header">
                <h3>Select Activities</h3>
                <div class="selection-controls">
                    <button type="button" id="select-all" class="btn btn-secondary">Select All</button>
                    <button type="button" id="clear-all" class="btn btn-secondary">Clear All</button>
                    <span class="selection-count">
                        <span id="selected-count">0</span> activities selected
                    </span>
                </div>
            </div>
            
            <div class="activities-filter">
                <input type="text" 
                       id="activity-search" 
                       placeholder="Search activities by name or type..."
                       class="search-input">
                <select id="type-filter" class="filter-select">
                    <option value="">All Types</option>
                    <option value="Run">Run</option>
                    <option value="Ride">Ride</option>
                    <option value="Swim">Swim</option>
                    <option value="Hike">Hike</option>
                    <option value="Walk">Walk</option>
                    <option value="Workout">Workout</option>
                </select>
            </div>
            
            <div class="activities-selection">
                {% set selected_ids = [] %}
                {% if aggregate %}
                    {% for activity in aggregate.activities %}
                        {% set _ = selected_ids.append(activity.id|string) %}
                    {% endfor %}
                {% endif %}
                
                {% for activity in activities %}
                <div class="activity-option" data-type="{{ activity.type }}" data-name="{{ activity.name|lower }}">
                    <label class="activity-checkbox">
                        <input type="checkbox" 
                               name="selected_activities" 
                               value="{{ activity.id }}"
                               {% if activity.id|string in selected_ids %}checked{% endif %}>
                        <div class="activity-info">
                            <div class="activity-header">
                                <h4>{{ activity.name }}</h4>
                                <div class="activity-meta">
                                    <span class="activity-type">{{ activity.type }}</span>
                                    <span class="activity-date">{{ activity.start_date_local[:10] }}</span>
                                </div>
                            </div>
                            <div class="activity-stats">
                                <span class="stat">{{ "%.1f"|format(activity.distance * 0.000621371) }} mi</span>
                                <span class="stat">{{ activity.elapsed_time // 60 }} min</span>
                                {% if activity.total_elevation_gain %}
                                    <span class="stat">{{ "%.0f"|format(activity.total_elevation_gain * 3.28084) }} ft</span>
                                {% endif %}
                            </div>
                        </div>
                    </label>
                </div>
                {% endfor %}
            </div>
        </div>
        
        <div class="form-actions">
            <button type="submit" class="btn btn-primary btn-large">
                {% if mode == 'edit' %}Update Aggregate{% else %}Create Aggregate{% endif %}
            </button>
            <a href="/aggregates" class="btn btn-secondary btn-large">Cancel</a>
        </div>
    </form>
</div>

<style>
.form-container {
    max-width: 1000px;
    margin: 0 auto;
    padding: 20px;
}

.header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
    border-bottom: 1px solid #e5e7eb;
    padding-bottom: 20px;
}

.header h1 {
    margin: 0;
    color: #1f2937;
}

.btn {
    text-decoration: none;
    padding: 8px 16px;
    border-radius: 6px;
    font-weight: 500;
    transition: all 0.2s;
    border: none;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 5px;
    font-family: inherit;
    font-size: 0.875rem;
    line-height: 1.5;
    user-select: none;
}

.btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    pointer-events: none;
}

.btn-primary {
    background-color: #fc4c02;
    color: white;
}

.btn-primary:hover {
    background-color: #ea580c;
}

.btn-secondary {
    background-color: #e5e7eb;
    color: #374151;
}

.btn-secondary:hover {
    background-color: #d1d5db;
}

.btn-back {
    background-color: #6b7280;
    color: white;
}

.btn-back:hover {
    background-color: #4b5563;
    text-decoration: none;
    color: white;
}

.btn-large {
    padding: 12px 24px;
    font-size: 1rem;
}

.form-section {
    margin-bottom: 32px;
}

.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    color: #374151;
    font-weight: 500;
}

.form-group input {
    width: 100%;
    padding: 12px;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    font-size: 1rem;
    box-sizing: border-box;
}

.form-group input:focus {
    outline: none;
    border-color: #fc4c02;
    box-shadow: 0 0 0 3px rgba(252, 76, 2, 0.1);
}

.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.section-header h3 {
    margin: 0;
    color: #1f2937;
}

.selection-controls {
    display: flex;
    align-items: center;
    gap: 12px;
}

.selection-count {
    color: #6b7280;
    font-size: 0.875rem;
    font-weight: 500;
}

.activities-filter {
    display: flex;
    gap: 12px;
    margin-bottom: 20px;
}

.search-input, .filter-select {
    padding: 8px 12px;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    font-size: 0.875rem;
}

.search-input {
    flex: 1;
}

.search-input:focus, .filter-select:focus {
    outline: none;
    border-color: #fc4c02;
    box-shadow: 0 0 0 2px rgba(252, 76, 2, 0.1);
}

.filter-select {
    min-width: 150px;
    background-color: white;
    cursor: pointer;
}

.activities-selection {
    max-height: 500px;
    overflow-y: auto;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    padding: 16px;
    background-color: #f9fafb;
}

.activity-option {
    margin-bottom: 12px;
}

.activity-option.hidden {
    display: none;
}

.activity-option:last-child {
    margin-bottom: 0;
}

.activity-checkbox {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    padding: 16px;
    background-color: white;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
    width: 100%;
    box-sizing: border-box;
}

.activity-checkbox:hover {
    border-color: #d1d5db;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
}

.activity-checkbox input[type="checkbox"] {
    margin: 4px 0 0 0;
    width: 16px;
    height: 16px;
    cursor: pointer;
}

.activity-checkbox input[type="checkbox"]:checked + .activity-info {
    background-color: #fef3f2;
}

.activity-info {
    flex: 1;
    padding: 4px 8px;
    border-radius: 4px;
    transition: background-color 0.2s;
}

.activity-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 8px;
}

.activity-header h4 {
    margin: 0;
    color: #1f2937;
    font-size: 1rem;
    font-weight: 500;
    flex: 1;
    margin-right: 12px;
}

.activity-meta {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-shrink: 0;
}

.activity-type {
    background-color: #fc4c02;
    color: white;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 500;
    text-transform: uppercase;
}

.activity-date {
    color: #6b7280;
    font-size: 0.75rem;
}

.activity-stats {
    display: flex;
    gap: 16px;
    color: #6b7280;
    font-size: 0.875rem;
}

.form-actions {
    display: flex;
    gap: 16px;
    justify-content: center;
    padding-top: 32px;
    border-top: 1px solid #e5e7eb;
}

.no-activities-message {
    text-align: center;
    padding: 32px;
    color: #6b7280;
    font-style: italic;
}

@media (max-width: 768px) {
    .form-container {
        padding: 15px;
    }
    
    .header {
        flex-direction: column;
        gap: 15px;
        align-items: stretch;
    }
    
    .section-header {
        flex-direction: column;
        gap: 12px;
        align-items: stretch;
    }
    
    .selection-controls {
        justify-content: space-between;
    }
    
    .activities-filter {
        flex-direction: column;
    }
    
    .activity-header {
        flex-direction: column;
        gap: 8px;
        align-items: flex-start;
    }
    
    .activity-meta {
        align-self: flex-start;
    }
    
    .activity-stats {
        flex-wrap: wrap;
        gap: 12px;
    }
    
    .form-actions {
        flex-direction: column;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Get DOM elements
    const searchInput = document.getElementById('activity-search');
    const typeFilter = document.getElementById('type-filter');
    const selectAllBtn = document.getElementById('select-all');
    const clearAllBtn = document.getElementById('clear-all');
    const selectedCountSpan = document.getElementById('selected-count');
    const activityOptions = document.querySelectorAll('.activity-option');
    const checkboxes = document.querySelectorAll('input[name="selected_activities"]');
    
    // Initialize selected count
    updateSelectedCount();
    
    // Search functionality
    searchInput.addEventListener('input', function() {
        filterActivities();
    });
    
    // Type filter functionality
    typeFilter.addEventListener('change', function() {
        filterActivities();
    });
    
    // Debug: Add click event listeners with error handling
    if (selectAllBtn) {
        selectAllBtn.addEventListener('click', function(e) {
            e.preventDefault();
            console.log('Select All clicked');
            const visibleCheckboxes = getVisibleCheckboxes();
            console.log('Found', visibleCheckboxes.length, 'visible checkboxes');
            visibleCheckboxes.forEach(function(checkbox) {
                checkbox.checked = true;
            });
            updateSelectedCount();
        });
    }
    
    if (clearAllBtn) {
        clearAllBtn.addEventListener('click', function(e) {
            e.preventDefault();
            console.log('Clear All clicked');
            const visibleCheckboxes = getVisibleCheckboxes();
            console.log('Found', visibleCheckboxes.length, 'visible checkboxes');
            visibleCheckboxes.forEach(function(checkbox) {
                checkbox.checked = false;
            });
            updateSelectedCount();
        });
    }
    
    // Update count when checkboxes change
    checkboxes.forEach(function(checkbox) {
        checkbox.addEventListener('change', function() {
            updateSelectedCount();
        });
    });
    
    // Filter activities based on search and type
    function filterActivities() {
        const searchTerm = searchInput.value.toLowerCase().trim();
        const selectedType = typeFilter.value;
        
        activityOptions.forEach(function(option) {
            const activityName = option.dataset.name;
            const activityType = option.dataset.type;
            
            const matchesSearch = !searchTerm || activityName.includes(searchTerm);
            const matchesType = !selectedType || activityType === selectedType;
            
            if (matchesSearch && matchesType) {
                option.classList.remove('hidden');
            } else {
                option.classList.add('hidden');
            }
        });
        
        // Update selection controls based on visible activities
        updateSelectionControls();
    }
    
    // Get visible checkboxes
    function getVisibleCheckboxes() {
        const visibleCheckboxes = [];
        activityOptions.forEach(function(option) {
            if (!option.classList.contains('hidden')) {
                const checkbox = option.querySelector('input[type="checkbox"]');
                if (checkbox) {
                    visibleCheckboxes.push(checkbox);
                }
            }
        });
        return visibleCheckboxes;
    }
    
    // Update selected count
    function updateSelectedCount() {
        const checkedBoxes = document.querySelectorAll('input[name="selected_activities"]:checked');
        selectedCountSpan.textContent = checkedBoxes.length;
    }
    
    // Update selection controls based on visible activities
    function updateSelectionControls() {
        const visibleCheckboxes = getVisibleCheckboxes();
        const hasVisibleActivities = visibleCheckboxes.length > 0;
        
        selectAllBtn.disabled = !hasVisibleActivities;
        clearAllBtn.disabled = !hasVisibleActivities;
    }
    
    // Form validation
    const form = document.querySelector('.aggregate-form');
    if (form) {
        form.addEventListener('submit', function(e) {
            const nameInput = document.getElementById('name');
            const checkedBoxes = document.querySelectorAll('input[name="selected_activities"]:checked');
            
            if (!nameInput.value.trim()) {
                e.preventDefault();
                alert('Please enter a name for your aggregate.');
                nameInput.focus();
                return;
            }
            
            if (checkedBoxes.length === 0) {
                e.preventDefault();
                alert('Please select at least one activity for your aggregate.');
                return;
            }
        });
    }
    
    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        // Ctrl+A or Cmd+A to select all (when search input is not focused)
        if ((e.ctrlKey || e.metaKey) && e.key === 'a' && document.activeElement !== searchInput) {
            e.preventDefault();
            selectAllBtn.click();
        }
        
        // Escape to clear search
        if (e.key === 'Escape' && document.activeElement === searchInput) {
            searchInput.value = '';
            filterActivities();
        }
    });
    
    // Focus search input with '/' key
    document.addEventListener('keydown', function(e) {
        if (e.key === '/' && document.activeElement.tagName !== 'INPUT') {
            e.preventDefault();
            searchInput.focus();
        }
    });
    
    // Initialize controls state
    updateSelectionControls();
});
</script>
{% endblock %}